import gspread
from oauth2client.service_account import ServiceAccountCredentials
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackQueryHandler, ContextTypes
import os
import asyncio
import time
import sys

# ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø –î–õ–Ø RENDER ====================
BOT_TOKEN = os.environ.get('BOT_TOKEN')
GOOGLE_SHEET_ID = os.environ.get('GOOGLE_SHEET_ID')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
if not BOT_TOKEN:
    print("‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("üí° –ù–∞ Render –¥–æ–±–∞–≤—å –≤ Environment Variables:")
    print("   Key: BOT_TOKEN")
    print("   Value: —Ç–≤–æ–π_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞")
    sys.exit(1)

if not GOOGLE_SHEET_ID:
    print("‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: GOOGLE_SHEET_ID –Ω–µ –Ω–∞–π–¥–µ–Ω")

# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', 
    level=logging.INFO,
    handlers=[
        logging.StreamHandler(sys.stdout),
    ]
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
CHOOSE_CATEGORY, SEARCH_PRODUCT, ENTER_QUANTITY, ENTER_CONTACTS = range(4)

# ==================== GOOGLE SHEETS –§–£–ù–ö–¶–ò–ò ====================

def init_google_sheets():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets"""
    scope = [
        'https://spreadsheets.google.com/feeds',
        'https://www.googleapis.com/auth/spreadsheets',
        'https://www.googleapis.com/auth/drive'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ credentials.json
    if not os.path.exists('credentials.json'):
        print("‚ùå –§–∞–π–ª credentials.json –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return None
    
    try:
        creds = ServiceAccountCredentials.from_json_keyfile_name('credentials.json', scope)
        client = gspread.authorize(creds)
        print("‚úÖ Google Sheets –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞")
        return client
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google Sheets: {e}")
        return None

def load_products_from_sheet(sheet_name):
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —É—á–µ—Ç–æ–º —É–∂–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö"""
    try:
        client = init_google_sheets()
        if not client:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Google Sheets")
            return []
            
        spreadsheet = client.open_by_key(GOOGLE_SHEET_ID)
        
        try:
            worksheet = spreadsheet.worksheet(sheet_name)
        except:
            print(f"‚ùå –õ–∏—Å—Ç '{sheet_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return []
        
        data = worksheet.get_all_values()
        
        if not data or len(data) <= 1:
            print(f"‚ùå –õ–∏—Å—Ç '{sheet_name}' –ø—É—Å—Ç")
            return []
        
        headers = data[0]
        product_dict = {}
        
        name_idx = -1
        quantity_idx = -1
        ordered_idx = -1
        box_idx = -1
        id_idx = -1
        desc_idx = -1
        
        for i, header in enumerate(headers):
            header_lower = str(header).lower().strip()
            
            if any(word in header_lower for word in ['–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–Ω–∞–∑–≤–∞–Ω–∏–µ', '—Ç–æ–≤–∞—Ä']):
                name_idx = i
            elif any(word in header_lower for word in ['–∫–æ–ª-–≤–æ', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ']):
                quantity_idx = i
            elif any(word in header_lower for word in ['–∑–∞–∫–∞–∑–∞–Ω–æ', '—Ä–µ–∑–µ—Ä–≤', '–±—Ä–æ–Ω—å']):
                ordered_idx = i
            elif '–∫–æ—Ä–æ–±–∫–∞' in header_lower:
                box_idx = i
            elif 'id' in header_lower or '–∞—Ä—Ç–∏–∫—É–ª' in header_lower:
                id_idx = i
            elif any(word in header_lower for word in ['–æ–ø–∏—Å–∞–Ω–∏–µ', '–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ', '–æ–ø–∏—Å']):
                desc_idx = i
        
        if ordered_idx == -1:
            print(f"‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ '–ó–∞–∫–∞–∑–∞–Ω–æ' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ª–∏—Å—Ç–µ '{sheet_name}'")
        
        print(f"üìä –õ–∏—Å—Ç '{sheet_name}': –Ω–∞–∑–≤–∞–Ω–∏–µ[{name_idx}], –∫–æ–ª-–≤–æ[{quantity_idx}], –∑–∞–∫–∞–∑–∞–Ω–æ[{ordered_idx}]")

        for row_idx, row in enumerate(data[1:], start=2):
            if name_idx >= len(row) or not str(row[name_idx]).strip():
                continue
            
            try:
                product_name = str(row[name_idx]).strip()
                
                quantity = int(row[quantity_idx]) if quantity_idx < len(row) and str(row[quantity_idx]).strip() else 0
                
                ordered = int(row[ordered_idx]) if ordered_idx != -1 and ordered_idx < len(row) and str(row[ordered_idx]).strip() else 0
                
                available = max(0, quantity - ordered)
                
                product_id = str(row[id_idx]).strip() if id_idx < len(row) else ''
                description = str(row[desc_idx]).strip() if desc_idx < len(row) else ''
                
                if product_name in product_dict:
                    product_dict[product_name]['total_quantity'] += quantity
                    product_dict[product_name]['ordered'] += ordered
                    product_dict[product_name]['available'] = max(0, product_dict[product_name]['total_quantity'] - product_dict[product_name]['ordered'])
                else:
                    product_dict[product_name] = {
                        'name': product_name,
                        'total_quantity': quantity,
                        'ordered': ordered,
                        'available': available,
                        'product_id': product_id,
                        'description': description,
                        'sheet_name': sheet_name,
                        'ordered_col_idx': ordered_idx,
                        'rows': []
                    }
                
                product_dict[product_name]['rows'].append(row_idx)
                
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row_idx}: {e}")
                continue
        
        product_data = list(product_dict.values())
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(product_data)} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ '{sheet_name}'")
        print(f"üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {sum(p['total_quantity'] for p in product_data)}, –ó–∞–∫–∞–∑–∞–Ω–æ: {sum(p['ordered'] for p in product_data)}, –î–æ—Å—Ç—É–ø–Ω–æ: {sum(p['available'] for p in product_data)}")
        
        return product_data
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        return []

def update_ordered_quantity(sheet_name, product_name, additional_ordered, row_numbers):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ '–ó–∞–∫–∞–∑–∞–Ω–æ' –¥–ª—è —Ç–æ–≤–∞—Ä–∞"""
    try:
        client = init_google_sheets()
        if not client:
            return False
            
        spreadsheet = client.open_by_key(GOOGLE_SHEET_ID)
        worksheet = spreadsheet.worksheet(sheet_name)
        
        headers = worksheet.row_values(1)
        ordered_idx = -1
        
        for i, header in enumerate(headers, start=1):
            if any(word in str(header).lower() for word in ['–∑–∞–∫–∞–∑–∞–Ω–æ', '—Ä–µ–∑–µ—Ä–≤', '–±—Ä–æ–Ω—å']):
                ordered_idx = i
                break
        
        if ordered_idx == -1:
            print(f"‚ö†Ô∏è –°–æ–∑–¥–∞—é –∫–æ–ª–æ–Ω–∫—É '–ó–∞–∫–∞–∑–∞–Ω–æ' –≤ –ª–∏—Å—Ç–µ '{sheet_name}'")
            worksheet.update_cell(1, len(headers) + 1, '–ó–∞–∫–∞–∑–∞–Ω–æ')
            ordered_idx = len(headers) + 1
        
        for row in row_numbers:
            current_ordered = worksheet.cell(row, ordered_idx).value
            if not current_ordered or not current_ordered.strip():
                current_ordered = 0
            else:
                try:
                    current_ordered = int(current_ordered)
                except:
                    current_ordered = 0
            
            new_ordered = current_ordered + additional_ordered
            worksheet.update_cell(row, ordered_idx, new_ordered)
        
        print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ '–ó–∞–∫–∞–∑–∞–Ω–æ' –¥–ª—è '{product_name}': +{additional_ordered}")
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: {e}")
        return False

# ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê ====================

async def start(update: Update, context):
    """–ù–∞—á–∞–ª–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –±/—É —Ç–æ–≤–∞—Ä–∞—Ö"""
    context.user_data.clear()
    
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        message = query.message
    else:
        message = update.message
    
    warning_text = "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è\n\n–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ ‚Äî –ë/–£ (–±—ã–≤—à–∏–µ –≤ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏).\n\n–ü—Ä–æ–¥–æ–ª–∂–∞—è, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏."
    
    await message.reply_text(warning_text)
    
    await asyncio.sleep(1)
    
    keyboard = [
        [InlineKeyboardButton("üíª –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ (MAIN)", callback_data='main')],
        [InlineKeyboardButton("‚ö° –ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è (PSU)", callback_data='psu')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    category_text = "üéØ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:\n\n‚Ä¢ üíª –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ (MAIN) ‚Äî –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–µ –ø–ª–∞—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã\n‚Ä¢ ‚ö° –ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è (PSU) ‚Äî –±–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏\n\nüëá –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
    
    await message.reply_text(category_text, reply_markup=reply_markup)
    
    return CHOOSE_CATEGORY

async def button_handler(update: Update, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    query = update.callback_query
    await query.answer()
    
    category_map = {
        'main': ('üíª –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ', 'MAIN'),
        'psu': ('‚ö° –ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è', 'PSU')
    }
    
    chosen = query.data
    category_name, sheet_name = category_map.get(chosen, ('', ''))
    
    context.user_data['category'] = category_name
    context.user_data['sheet_name'] = sheet_name
    
    await query.edit_message_text(f"{category_name}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:")
    
    return SEARCH_PRODUCT

async def search_product(update: Update, context):
    """–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ —Å —É—á–µ—Ç–æ–º —É–∂–µ –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö"""
    user_input = update.message.text.strip().lower()
    sheet_name = context.user_data.get('sheet_name', 'MAIN')
    category_name = context.user_data.get('category', '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ')
    
    products = load_products_from_sheet(sheet_name)
    
    if not products:
        error_text = f"""‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}
–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."""
        
        keyboard = [[InlineKeyboardButton("üîÑ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é", callback_data='new_search')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(error_text, reply_markup=reply_markup)
        return CHOOSE_CATEGORY
    
    found_products = []
    for product in products:
        if user_input in product['name'].lower():
            found_products.append(product)
    
    if found_products:
        product = found_products[0]
        context.user_data['product'] = product
        context.user_data['product_rows'] = product.get('rows', [])
        
        product_info = f"""‚úÖ –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω!

üì¶ –ù–∞–∑–≤–∞–Ω–∏–µ: {product['name']}
üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}
üìä –í—Å–µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–µ: {product['total_quantity']} —à—Ç.
üì¶ –£–∂–µ –∑–∞–∫–∞–∑–∞–Ω–æ: {product['ordered']} —à—Ç.
‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞: {product['available']} —à—Ç."""
        
        if product.get('product_id'):
            product_info += f"\nüî¢ ID: {product['product_id']}"
        
        if product.get('description'):
            product_info += f"\nüìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: {product['description']}"
        
        product_info += "\n\nüõí –°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –≤–∞–º –Ω—É–∂–Ω–æ?"
        
        await update.message.reply_text(product_info)
        return ENTER_QUANTITY
        
    else:
        not_found_text = f"""‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω

–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}
–ü–æ –∑–∞–ø—Ä–æ—Å—É "{user_input}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.

üîç –°–æ–≤–µ—Ç—ã:
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è
‚Ä¢ –ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
        
        keyboard = [[InlineKeyboardButton("üîÑ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é", callback_data='new_search')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(not_found_text, reply_markup=reply_markup)
        return SEARCH_PRODUCT

async def get_quantity(update: Update, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""
    try:
        quantity = int(update.message.text)
        product = context.user_data['product']
        
        if quantity <= 0:
            await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ:")
            return ENTER_QUANTITY
        elif quantity > product['available']:
            stock_text = f"""‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ {product['available']} —à—Ç.
(—É–∂–µ –∑–∞–∫–∞–∑–∞–Ω–æ: {product['ordered']} —à—Ç. –∏–∑ {product['total_quantity']} —à—Ç.)

üì¶ –í–≤–µ–¥–∏—Ç–µ –º–µ–Ω—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:"""
            await update.message.reply_text(stock_text)
            return ENTER_QUANTITY
        else:
            context.user_data['quantity'] = quantity
            
            contacts_text = """üìû –û—Ç–ª–∏—á–Ω–æ!

–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏:

üì± –§–æ—Ä–º–∞—Ç: +7XXX XXX-XX-XX –∏–ª–∏ 8XXX XXX-XX-XX

‚è∞ –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞"""
            await update.message.reply_text(contacts_text)
            return ENTER_CONTACTS
            
    except ValueError:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ:")
        return ENTER_QUANTITY

async def get_contacts(update: Update, context):
    """–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""
    contacts = update.message.text
    product = context.user_data['product']
    quantity = context.user_data['quantity']
    product_rows = context.user_data.get('product_rows', [])
    category = context.user_data.get('category', '–¢–æ–≤–∞—Ä')
    sheet_name = context.user_data.get('sheet_name', 'MAIN')
    
    update_success = update_ordered_quantity(sheet_name, product['name'], quantity, product_rows)
    
    order_text = f"""üéä –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω!

üìã –î–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–∞:
‚îú üì¶ –¢–æ–≤–∞—Ä: {product['name']}
‚îú üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}
‚îú üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity} —à—Ç.
‚îî üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã: {contacts}

{'‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –±–∞–∑–µ' if update_success else '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É'}

‚è∞ –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!

–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! ‚ù§Ô∏è"""
    
    await update.message.reply_text(order_text)
    
    logger.info(f"üìù –ó–∞–ø—Ä–æ—Å: {product['name']} - {quantity} —à—Ç. - {contacts} - –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –±–∞–∑–µ: {update_success}")
    
    keyboard = [[InlineKeyboardButton("üîÑ –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data='new_search')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text("–•–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏ –µ—â–µ —Ç–æ–≤–∞—Ä—ã?", reply_markup=reply_markup)
    return ConversationHandler.END

async def new_search_handler(update: Update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–æ–≤—ã–π –ø–æ–∏—Å–∫' –∏ '–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é'"""
    query = update.callback_query
    await query.answer()
    
    context.user_data.clear()
    
    warning_text = "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è\n\n–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ ‚Äî –ë/–£ (–±—ã–≤—à–∏–µ –≤ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏).\n\n–ü—Ä–æ–¥–æ–ª–∂–∞—è, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω—ã —Å —É—Å–ª–æ–≤–∏—è–º–∏."
    
    await query.message.reply_text(warning_text)
    
    await asyncio.sleep(1)
    
    keyboard = [
        [InlineKeyboardButton("üíª –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ (MAIN)", callback_data='main')],
        [InlineKeyboardButton("‚ö° –ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è (PSU)", callback_data='psu')]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    category_text = "üéØ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:\n\n‚Ä¢ üíª –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ (MAIN) ‚Äî –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–µ –ø–ª–∞—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã\n‚Ä¢ ‚ö° –ë–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è (PSU) ‚Äî –±–ª–æ–∫–∏ –ø–∏—Ç–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω–æ–π –º–æ—â–Ω–æ—Å—Ç–∏\n\nüëá –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
    
    await query.message.reply_text(category_text, reply_markup=reply_markup)
    return CHOOSE_CATEGORY

async def cancel(update: Update, context):
    await update.message.reply_text("üö´ –ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω. –ù–∞–ø–∏—à–∏—Ç–µ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.")
    context.user_data.clear()
    return ConversationHandler.END

async def help_command(update: Update, context):
    help_text = """üÜò –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É

üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
‚îú /start - –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞
‚îú /help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
‚îî /cancel - –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–∏—Å–∫

üí° –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:
1. –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start
2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤
3. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
4. –£–∫–∞–∂–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
5. –û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏

üìû –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å!"""
    await update.message.reply_text(help_text)

# ==================== –ó–ê–ü–£–°–ö –î–õ–Ø RENDER ====================

def create_application():
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏"""
    try:
        application = Application.builder().token(BOT_TOKEN).build()
        
        conv_handler = ConversationHandler(
            entry_points=[
                CommandHandler('start', start),
                CallbackQueryHandler(new_search_handler, pattern='^new_search$')
            ],
            states={
                CHOOSE_CATEGORY: [
                    CallbackQueryHandler(button_handler, pattern='^(main|psu)$'),
                    CallbackQueryHandler(new_search_handler, pattern='^new_search$')
                ],
                SEARCH_PRODUCT: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, search_product),
                    CallbackQueryHandler(new_search_handler, pattern='^new_search$')
                ],
                ENTER_QUANTITY: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, get_quantity),
                    CallbackQueryHandler(new_search_handler, pattern='^new_search$')
                ],
                ENTER_CONTACTS: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, get_contacts),
                    CallbackQueryHandler(new_search_handler, pattern='^new_search$')
                ],
            },
            fallbacks=[
                CommandHandler('cancel', cancel),
                CommandHandler('start', start),
                CallbackQueryHandler(new_search_handler, pattern='^new_search$')
            ],
            allow_reentry=True,
            per_user=True,
            per_chat=True
        )
        
        application.add_handler(conv_handler)
        application.add_handler(CommandHandler("help", help_command))
        application.add_handler(CallbackQueryHandler(new_search_handler, pattern='^new_search$'))
        
        return application
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {e}")
        raise

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –¥–ª—è Render"""
    print(f"{'='*60}")
    print("ü§ñ –ë–û–¢ –î–õ–Ø –ë/–£ –¢–û–í–ê–†–û–í")
    print(f"üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ Render: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üìä BOT_TOKEN: {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if BOT_TOKEN else '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")
    print(f"üìÅ GOOGLE_SHEET_ID: {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if GOOGLE_SHEET_ID else '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")
    print(f"{'='*60}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ credentials.json
    if os.path.exists('credentials.json'):
        print("‚úÖ –§–∞–π–ª credentials.json –Ω–∞–π–¥–µ–Ω")
    else:
        print("‚ùå –§–∞–π–ª credentials.json –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ!")
        print("üí° –£–±–µ–¥–∏—Å—å —á—Ç–æ credentials.json –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ GitHub")
    
    try:
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        application = create_application()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º polling (–¥–ª—è Render –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ polling)
        print("üîÑ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ polling...")
        
        application.run_polling(
            poll_interval=1.0,
            timeout=30,
            drop_pending_updates=True,
            allowed_updates=Update.ALL_TYPES
        )
        
    except KeyboardInterrupt:
        print("\nüî¥ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        print("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
        time.sleep(10)
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
        os.execv(sys.executable, ['python'] + sys.argv)

if __name__ == '__main__':
    main()